import{s as e,r as u,p as l,e as t,d as o,o as n,j as a,v as r}from"./index-174ad176.js";import{i as V,I as i,H as s,J as c,p as d,k as m,m as f,E as p,x as E,S as _}from"./index.js";import{D as k}from"./dict-tag-15f2a908.js";import{u as h,P as C,a as w}from"./pagination-87b07e34.js";import{R as b}from"./right-tool-bar-f10e816b.js";import{u as g}from"./useFormUtil-98c17c20.js";import{h as v}from"./usePermission-16d8d5ac.js";import{u as y}from"./useTableUtil-0e4d2f9a.js";import{s as N}from"./constDynamicRoutes-5c9c22de.js";import{d as x}from"./dict-2940434e.js";import{_ as P}from"./scheduled-tasks-detail.vue_vue_type_script_setup_true_lang-ad2b2791.js";import{_ as B}from"./scheduled-tasks-dialog.vue_vue_type_script_setup_true_name_menu-dialog_lang-a0d4c991.js";import"./_plugin-vue_export-helper-0909ef10.js";const j={key:0},T={key:1},S={key:0},D={key:1},F=Vue.defineComponent({name:N.scheduledTasks.path}),I=Vue.defineComponent({...F,setup(N){const{t:F}=VueI18n.useI18n({useScope:"global"}),I=Vue.ref(),U=Vue.ref(!0),L=Vue.ref({}),J=Vue.ref(!1),M=V(x.sysJobGroup,x.sysJobStatus),{formReset:$}=g(),{useTableSelectChange:R}=y(),{handleSelectionChangeFn:O,ids:z,values:G,single:K,selected:q}=R(),Q=e=>O(e,"job_id","job_name"),{pause:A,resume:H}=i((()=>oe()),1500),W=Vue.ref(!1),X=e=>{e?H():A()},Y=Vue.ref({page_num:1,page_size:10}),Z=Vue.ref([]),ee=Vue.ref(""),ue=Vue.ref(!1),le=Vue.ref(""),{list:te,getListFn:oe,total:ne}=h(s.getList,Y,Z),ae=()=>{$(I.value),Z.value=[],oe()},re=()=>{L.value={task_count:0,task_id:0,status:"0",misfire_policy:"1"},J.value=!0,ee.value="新增任务"},Ve=async e=>{if(null==e?void 0:e.job_id)L.value=e;else{const e=z.value[0],{data:u,execute:l}=m(s.getById,{job_id:e});await l(),L.value=u.value}J.value=!0,ee.value="更新任务"},ie=async e=>{await w(s.delete,"job_id",z,"job_name",G,"job_ids",e)&&oe()},se=e=>{le.value=e.job_id,ue.value=!0,ee.value="任务详情"},ce=e=>{const u=(null==e?void 0:e.job_id)||"all";E.push({name:_,query:{job_id:u}})},de=()=>{ue.value=!1,J.value=!1,oe()};return Vue.onDeactivated((()=>{A()})),Vue.onActivated((()=>{W.value?H():A()})),(V,i)=>(Vue.openBlock(),Vue.createElementBlock("div",null,[Vue.withDirectives(Vue.createVNode(Vue.unref(ElementPlus.ElForm),{ref_key:"queryRef",ref:I,inline:!0,model:Y.value,"label-width":"68px",class:"base-form"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElFormItem),{label:"任务名称",prop:"job_name"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElInput),{modelValue:Y.value.job_name,"onUpdate:modelValue":i[0]||(i[0]=e=>Y.value.job_name=e),placeholder:"请输入任务名称",clearable:"",onKeyup:Vue.withKeys(Vue.unref(oe),["enter"])},null,8,["modelValue","onKeyup"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElFormItem),{label:"任务组名",prop:"job_group"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElSelect),{modelValue:Y.value.job_group,"onUpdate:modelValue":i[1]||(i[1]=e=>Y.value.job_group=e),placeholder:"请选择任务组名",clearable:""},{default:Vue.withCtx((()=>[(Vue.openBlock(!0),Vue.createElementBlock(Vue.Fragment,null,Vue.renderList(Vue.unref(M)[Vue.unref(x).sysJobGroup],(e=>(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElOption),{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElFormItem),{label:"任务状态",prop:"status"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElSelect),{modelValue:Y.value.status,"onUpdate:modelValue":i[2]||(i[2]=e=>Y.value.status=e),placeholder:"请选择任务状态",clearable:""},{default:Vue.withCtx((()=>[(Vue.openBlock(!0),Vue.createElementBlock(Vue.Fragment,null,Vue.renderList(Vue.unref(M)[Vue.unref(x).sysJobStatus],(e=>(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElOption),{key:e.value,label:e.label,value:e.value},null,8,["label","value"])))),128))])),_:1},8,["modelValue"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElFormItem),null,{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{icon:Vue.unref(e),type:"primary",onClick:Vue.unref(oe)},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(Vue.unref(F)("common.search")),1)])),_:1},8,["icon","onClick"]),Vue.createVNode(Vue.unref(ElementPlus.ElButton),{icon:Vue.unref(u),onClick:ae},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(Vue.unref(F)("common.reset")),1)])),_:1},8,["icon"])])),_:1})])),_:1},8,["model"]),[[Vue.vShow,U.value]]),Vue.createVNode(Vue.unref(ElementPlus.ElRow),{gutter:10,class:"m-b-8px",style:{height:"35px"}},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElCol),{span:1.5},{default:Vue.withCtx((()=>[Vue.unref(v)(Vue.unref(s).add)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElButton),{key:0,type:"primary",plain:"",icon:Vue.unref(l),onClick:re},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(Vue.unref(F)("common.add")),1)])),_:1},8,["icon"])):Vue.createCommentVNode("",!0)])),_:1},8,["span"]),Vue.createVNode(Vue.unref(ElementPlus.ElCol),{span:1.5},{default:Vue.withCtx((()=>[Vue.unref(v)(Vue.unref(s).edit)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElButton),{key:0,type:"success",plain:"",icon:Vue.unref(t),disabled:!Vue.unref(K),onClick:i[3]||(i[3]=e=>Ve())},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(Vue.unref(F)("common.edit")),1)])),_:1},8,["icon","disabled"])):Vue.createCommentVNode("",!0)])),_:1},8,["span"]),Vue.createVNode(Vue.unref(ElementPlus.ElCol),{span:1.5},{default:Vue.withCtx((()=>[Vue.unref(v)(Vue.unref(s).delete)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElButton),{key:0,type:"danger",plain:"",icon:Vue.unref(o),disabled:!Vue.unref(q),onClick:i[4]||(i[4]=e=>ie())},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(Vue.unref(F)("common.delete")),1)])),_:1},8,["icon","disabled"])):Vue.createCommentVNode("",!0)])),_:1},8,["span"]),Vue.createVNode(Vue.unref(ElementPlus.ElCol),{span:1.5},{default:Vue.withCtx((()=>[Vue.unref(v)(Vue.unref(c).getList)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElButton),{key:0,type:"info",plain:"",icon:Vue.unref(n),onClick:i[5]||(i[5]=e=>ce())},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(Vue.unref(F)("common.log")),1)])),_:1},8,["icon"])):Vue.createCommentVNode("",!0)])),_:1},8,["span"]),Vue.createVNode(Vue.unref(ElementPlus.ElCol),{span:1.5},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElCheckbox),{modelValue:W.value,"onUpdate:modelValue":i[6]||(i[6]=e=>W.value=e),border:"",label:Vue.unref(F)("common.auto")+Vue.unref(F)("common.reFresh"),onChange:X},null,8,["modelValue","label"])])),_:1},8,["span"]),Vue.createVNode(b,{showSearch:U.value,"onUpdate:showSearch":i[7]||(i[7]=e=>U.value=e),onQueryTable:Vue.unref(oe)},null,8,["showSearch","onQueryTable"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTable),{data:Vue.unref(te),onSelectionChange:Q,"tooltip-effect":"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{type:"selection",width:"55",align:"center"}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"任务ID",width:"100",align:"center","show-overflow-tooltip":""},{default:Vue.withCtx((e=>[Vue.createVNode(Vue.unref(ElementPlus.ElTag),{type:"warning",onClick:u=>ce(e.row)},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElLink),{type:"warning"},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(e.row.task_id),1)])),_:2},1024)])),_:2},1032,["onClick"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"任务名称",align:"center",prop:"job_name","show-overflow-tooltip":!0},{default:Vue.withCtx((e=>[Vue.createVNode(Vue.unref(ElementPlus.ElLink),{type:"success",onClick:u=>se(e.row)},{default:Vue.withCtx((()=>[Vue.createTextVNode(Vue.toDisplayString(e.row.job_name),1)])),_:2},1032,["onClick"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"任务组名",align:"center",prop:"job_group"},{default:Vue.withCtx((e=>[Vue.createVNode(k,{options:Vue.unref(M)[Vue.unref(x).sysJobGroup],value:e.row.job_group},null,8,["options","value"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"调用目标字符串",align:"center",prop:"invoke_target","show-overflow-tooltip":!0}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"cron执行表达式",align:"center",prop:"cron_expression","show-overflow-tooltip":!0}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"下次执行时间",align:"center","show-overflow-tooltip":!0},{default:Vue.withCtx((e=>["0"==e.row.status?(Vue.openBlock(),Vue.createElementBlock("span",j,"任务未运行")):(Vue.openBlock(),Vue.createElementBlock("span",T,Vue.toDisplayString(Vue.unref(d)(e.row.next_time)),1))])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"批次数",align:"center",width:"100","show-overflow-tooltip":!0},{default:Vue.withCtx((e=>["0"==e.row.task_count?(Vue.openBlock(),Vue.createElementBlock("span",S,"无限")):(Vue.openBlock(),Vue.createElementBlock("span",D,Vue.toDisplayString(e.row.task_count),1))])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"已执行",align:"center",prop:"run_count",width:"100","show-overflow-tooltip":!0}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"状态",align:"center"},{default:Vue.withCtx((e=>[Vue.createVNode(Vue.unref(ElementPlus.ElSwitch),{modelValue:e.row.status,"onUpdate:modelValue":u=>e.row.status=u,"active-value":"1","inactive-value":"0",onChange:u=>(async e=>{const u="1"===e.status?"启用":"停用";await ElementPlus.ElMessageBox.confirm(`确定要  ${u}  ${e.job_name}  吗?`,"任务状态",{type:"warning"}).then((async()=>{const{data:l,execute:t}=f(s.changeStatus,{job_id:e.job_id,status:e.status});await t(),l.value!==p&&(ElementPlus.ElMessage.success(`你成功 ${u} 任务 ${e.job_name}`),oe())})).catch((()=>{ElementPlus.ElMessage.info("你取消了操作"),e.status="0"===e.status?"1":"0"}))})(e.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])])),_:1}),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:"操作",align:"center",width:"200"},{default:Vue.withCtx((e=>[Vue.unref(v)(Vue.unref(s).edit)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:0,content:"修改",placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(t),onClick:u=>Ve(e.row)},null,8,["icon","onClick"])])),_:2},1024)):Vue.createCommentVNode("",!0),Vue.unref(v)(Vue.unref(s).delete)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:1,content:"删除",placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(o),onClick:u=>ie(e.row)},null,8,["icon","onClick"])])),_:2},1024)):Vue.createCommentVNode("",!0),Vue.unref(v)(Vue.unref(s).runOnce)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:2,content:"执行一次",placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(a),onClick:u=>(async e=>{await ElementPlus.ElMessageBox.confirm(`确定立即执行一次  ${e.job_name}  吗?`,"任务运行",{type:"info"}).then((async()=>{const{data:u,execute:l}=f(s.runOnce,{job_id:e.job_id,task_id:e.task_id});await l(),u.value!==p&&ElementPlus.ElMessage.success(`你成功运行任务 ${e.job_name}`)})).catch((()=>{ElementPlus.ElMessage.info("你取消了操作")}))})(e.row)},null,8,["icon","onClick"])])),_:2},1024)):Vue.createCommentVNode("",!0),Vue.unref(v)(Vue.unref(s).getById)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:3,content:"任务详细",placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(r),onClick:u=>se(e.row)},null,8,["icon","onClick"])])),_:2},1024)):Vue.createCommentVNode("",!0),Vue.unref(v)(Vue.unref(c).getList)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:4,content:"调度日志",placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(n),onClick:u=>ce(e.row)},null,8,["icon","onClick"])])),_:2},1024)):Vue.createCommentVNode("",!0)])),_:1})])),_:1},8,["data"]),Vue.withDirectives(Vue.createVNode(C,{page:Y.value.page_num,"onUpdate:page":i[8]||(i[8]=e=>Y.value.page_num=e),limit:Y.value.page_size,"onUpdate:limit":i[9]||(i[9]=e=>Y.value.page_size=e),total:Vue.unref(ne),onPagination:Vue.unref(oe)},null,8,["page","limit","total","onPagination"]),[[Vue.vShow,Vue.unref(ne)>0]]),ue.value?(Vue.openBlock(),Vue.createBlock(P,{key:0,"job-id":le.value,"open-detail":ue.value,title:ee.value,onCloseDialog:de},null,8,["job-id","open-detail","title"])):Vue.createCommentVNode("",!0),J.value?(Vue.openBlock(),Vue.createBlock(B,{key:1,"form-data":L.value,open:J.value,title:ee.value,onCloseDialog:de},null,8,["form-data","open","title"])):Vue.createCommentVNode("",!0)]))}});export{I as default};
