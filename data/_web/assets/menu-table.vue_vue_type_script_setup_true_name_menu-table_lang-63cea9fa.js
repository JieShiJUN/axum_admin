import{e,g as u,h as l,d as n}from"./index-174ad176.js";import{k as t,r as o,M as a,i as r,p as i,l as c}from"./index.js";import{D as s}from"./dict-tag-15f2a908.js";import{_ as m}from"./svg-icon.vue_vue_type_script_name_svg-icon_setup_true_lang-e57e6f2d.js";import{h as d}from"./usePermission-16d8d5ac.js";import{d as V}from"./dict-2940434e.js";import{_ as f}from"./menu-dialog.vue_vue_type_script_setup_true_name_menu-dialog_lang-6f9cf331.js";const p=Vue.defineComponent({name:"menu-table"}),v=Vue.defineComponent({...p,props:{queryParam:{type:Object,required:!0}},async setup(p,{expose:v}){let h,_;const w=p,{t:E}=VueI18n.useI18n({useScope:"global"}),C=Vue.ref(),y=Vue.ref(),b=Vue.ref(!1),k=Vue.ref(""),g=Vue.ref([]),N=()=>b.value=!1,T=Vue.ref({pid:"0",menu_name:"",menu_type:a.M,order_sort:0,status:"1",visible:"1",log_method:"3",data_cache_method:"1",is_frame:"0",is_cache:"1",data_scope:"0",remark:""}),P=r(V.sysNormalDisable,V.sysApiMethod,V.apiCacheMethod,V.apiLogMethod,V.sysShowHide,V.db),x=Vue.ref(),B=()=>{T.value={pid:"0",menu_name:"",menu_type:a.M,order_sort:0,status:"1",visible:"1",log_method:"3",data_cache_method:"1",is_frame:"0",is_cache:"1",data_scope:"0",remark:""}},M=async()=>{await L()},j=e=>{var u;let l;null==(u=C.value)||u.resetMenuForm(),B(),x.value=null==e?void 0:e.pid,A(),T.value.pid=e?e.id:"0",T.value.menu_name=(null==e?void 0:e.menu_type)===a.C?(null==e?void 0:e.menu_name)+"-":void 0,l=void 0===(null==e?void 0:e.menu_type)?a.M:(null==e?void 0:e.menu_type)===a.M?a.C:a.F,T.value.menu_type=l,T.value.id="",b.value=!0,k.value=E("common.add")+E("menu.menu")};v({handleAdd:j,getList:M});const D=Vue.ref(!0),{getLazyMenu:L,mainTree:F,menuTreeMap:S,menuList:q}=(e=>{const u=Vue.ref([]),l=Vue.ref({}),n=Vue.ref([]);return{getLazyMenu:async()=>{var a;const r=Vue.ref([]),i=Vue.ref({}),{data:c,execute:s}=t(o.getList,e);await s();const m=null==(a=c.value)?void 0:a.list;n.value=m;const d={};m.forEach((e=>{e.children=[];const u=e.id;d[u]=e})),m.forEach((e=>{var u;const l=d[e.pid];l&&(null==(u=l.children)||u.push(e))})),m.forEach((e=>{var u,l;if(0===(null==(l=null==(u=d[e.id])?void 0:u.children)?void 0:l.length)?delete d[e.id].children:d[e.id].hasChildren=!0,d[e.pid]){const u=i.value[e.pid];u?u.push(e):i.value[e.pid]=[e]}else{const u={...e};delete u.children,r.value.push(u)}})),u.value=r.value,l.value=i.value},mainTree:u,menuTreeMap:l,menuList:n}})(w.queryParam),A=()=>{const e=(e=>{const u={},l={},n=[];for(const o of e){const e=o.pid;null==u[e]&&(u[e]=[]),l[o.id]=o,o.menu_type===a.F&&(o.disabled=!0),u[e].push(o)}for(const o of e)null==l[o.pid]&&n.push(o);for(const o of n)t(o);function t(e){if(null!==u[e.id]&&(e.children=u[e.id]),e.children)for(const u of e.children)t(u)}return n})(q.value);g.value=[{id:"0",menu_name:E("menu.mainCategory"),children:e}]},z=new Map;async function I(e){let u=z.get(e);if(u){const{tree:e,treeNode:l,resolve:n}=u;G(e,l,n)}else D.value=!1,Vue.nextTick((()=>{D.value=!0}))}const G=(e,u,l)=>{const n=e.id;z.set(n,{tree:e,treeNode:u,resolve:l}),S.value[n]?setTimeout((()=>{l(S.value[n])}),1):(D.value=!1,Vue.nextTick((()=>{D.value=!0})))},H=async e=>{await M(),await I(e),e!==x.value&&await I(x.value)};return[h,_]=Vue.withAsyncContext((()=>M())),await h,_(),(t,a)=>(Vue.openBlock(),Vue.createElementBlock("div",null,[D.value?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTable),{key:0,ref_key:"menuTableRef",ref:y,data:Vue.unref(F),"row-key":"id",lazy:"",load:G,"tooltip-effect":"light","tree-props":{children:"children",hasChildren:"hasChildren"}},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"menu_name",label:Vue.unref(E)("menu.name"),"show-overflow-tooltip":!0,width:"200"},null,8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"icon",label:Vue.unref(E)("common.icon"),align:"center",width:"100"},{default:Vue.withCtx((e=>[Vue.createVNode(Vue.unref(ElementPlus.ElIcon),null,{default:Vue.withCtx((()=>[Vue.createVNode(m,{name:e.row.icon},null,8,["name"])])),_:2},1024)])),_:1},8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"order_sort",label:Vue.unref(E)("common.order"),width:"100"},null,8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"api",label:Vue.unref(E)("common.uniqueFlag"),"show-overflow-tooltip":!0},null,8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"component",label:Vue.unref(E)("menu.comp"),"show-overflow-tooltip":!0},null,8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"method",label:Vue.unref(E)("menu.method"),width:"80"},{default:Vue.withCtx((e=>[Vue.createVNode(s,{options:Vue.unref(P)[Vue.unref(V).sysApiMethod],value:e.row.method},null,8,["options","value"])])),_:1},8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"method",label:Vue.unref(E)("menu.dataScope"),width:"100"},{default:Vue.withCtx((e=>["GET"==e.row.method?(Vue.openBlock(),Vue.createBlock(s,{key:0,options:Vue.unref(P)[Vue.unref(V).sysNormalDisable],value:e.row.data_scope},null,8,["options","value"])):(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTag),{key:1},{default:Vue.withCtx((()=>[Vue.createTextVNode("not support")])),_:1}))])),_:1},8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"status",label:Vue.unref(E)("common.status"),width:"60"},{default:Vue.withCtx((e=>[Vue.createVNode(s,{options:Vue.unref(P)[Vue.unref(V).sysNormalDisable],value:e.row.status},null,8,["options","value"])])),_:1},8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{prop:"visible",label:Vue.unref(E)("common.show"),width:"60"},{default:Vue.withCtx((e=>[Vue.createVNode(s,{options:Vue.unref(P)[Vue.unref(V).sysShowHide],value:e.row.visible},null,8,["options","value"])])),_:1},8,["label"]),Vue.createVNode(Vue.unref(ElementPlus.ElTableColumn),{label:Vue.unref(E)("common.createTime"),align:"center",prop:"created_at","show-overflow-tooltip":""},{default:Vue.withCtx((e=>[Vue.createElementVNode("span",null,Vue.toDisplayString(Vue.unref(i)(e.row.created_at)),1)])),_:1},8,["label"]),Vue.unref(d)(Vue.unref(o).edit,Vue.unref(o).add,Vue.unref(o).delete)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTableColumn),{key:0,label:Vue.unref(E)("common.operation"),align:"center",width:"200","class-name":"small-padding fixed-width"},{default:Vue.withCtx((t=>[Vue.unref(d)(Vue.unref(o).edit)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:0,content:Vue.unref(E)("common.edit"),placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(e),style:{color:"chocolate"},onClick:e=>{return u=t.row,null==(l=C.value)||l.resetMenuForm(),B(),x.value=u.pid,A(),T.value=u,b.value=!0,void(k.value=E("common.update")+E("menu.menu")+" - "+u.menu_name);var u,l}},null,8,["icon","onClick"])])),_:2},1032,["content"])):Vue.createCommentVNode("",!0),Vue.unref(d)(Vue.unref(o).edit)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:1,content:Vue.unref(E)("common.copy"),placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(u),style:{color:"violet"},onClick:e=>{return u=t.row,null==(l=C.value)||l.resetMenuForm(),B(),x.value=u.pid,A(),T.value=u,T.value.id="",b.value=!0,void(k.value=E("common.copy")+E("common.add")+E("menu.menu"));var u,l}},null,8,["icon","onClick"])])),_:2},1032,["content"])):Vue.createCommentVNode("",!0),Vue.unref(d)(Vue.unref(o).add)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:2,content:Vue.unref(E)("common.add"),placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{link:"",icon:Vue.unref(l),onClick:e=>j(t.row)},null,8,["icon","onClick"])])),_:2},1032,["content"])):Vue.createCommentVNode("",!0),Vue.unref(d)(Vue.unref(o).delete)?(Vue.openBlock(),Vue.createBlock(Vue.unref(ElementPlus.ElTooltip),{key:3,content:Vue.unref(E)("common.delete"),placement:"top",effect:"light"},{default:Vue.withCtx((()=>[Vue.createVNode(Vue.unref(ElementPlus.ElButton),{style:{color:"red"},link:"",icon:Vue.unref(n),onClick:e=>(async e=>{const u=e.id;await ElementPlus.ElMessageBox.confirm(E("commonTip.delete")+e.menu_name+"?",E("commonTip.deleteTitle"),{type:"warning"}).then((async()=>{const{execute:l}=c(o.delete,{id:u});await l(),await M(),await I(e.pid),ElementPlus.ElMessage.success(E("commonTip.deleteSuccess"))})).catch((()=>{ElementPlus.ElMessage.info(E("commonTip.deleteCancel"))}))})(t.row)},null,8,["icon","onClick"])])),_:2},1032,["content"])):Vue.createCommentVNode("",!0)])),_:1},8,["label"])):Vue.createCommentVNode("",!0)])),_:1},8,["data"])):Vue.createCommentVNode("",!0),Vue.createVNode(f,{ref_key:"menuDialogRef",ref:C,open:b.value,title:k.value,"form-data":T.value,"menu-select-tree":g.value,onCloseDialog:N,onGetList:M,onUpdateDom:H},null,8,["open","title","form-data","menu-select-tree"])]))}});export{v as _};
